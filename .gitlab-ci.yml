# ==============================================================================
# GitLab CI/CD Pipeline - FusionCloudX Infrastructure
# ==============================================================================
# Replaces Semaphore UI with GitLab's built-in CI/CD
# Manual jobs provide runbook-style execution (similar to Rundeck)
# ==============================================================================

# Global configuration
variables:
  # Terraform variables (set in GitLab CI/CD variables)
  TF_IN_AUTOMATION: "true"
  TF_INPUT: "false"
  # Ansible variables
  ANSIBLE_FORCE_COLOR: "true"
  ANSIBLE_HOST_KEY_CHECKING: "false"

# Define pipeline stages
stages:
  - validate
  - plan
  - apply
  - configure
  - destroy

# ==============================================================================
# TERRAFORM JOBS
# ==============================================================================

# Terraform Init (runs automatically on pipeline start)
terraform:init:
  stage: validate
  image: hashicorp/terraform:1.10
  before_script:
    - cd terraform/
  script:
    - terraform init
  cache:
    key: terraform-plugins
    paths:
      - terraform/.terraform/
  artifacts:
    paths:
      - terraform/.terraform/
    expire_in: 1 day

# Terraform Validate (runs automatically after init)
terraform:validate:
  stage: validate
  image: hashicorp/terraform:1.10
  dependencies:
    - terraform:init
  before_script:
    - cd terraform/
  script:
    - terraform validate
    - terraform fmt -check -recursive

# Terraform Plan (manual trigger - click to run)
terraform:plan:
  stage: plan
  image: hashicorp/terraform:1.10
  dependencies:
    - terraform:init
  before_script:
    - cd terraform/
  script:
    - terraform plan -out=tfplan
  artifacts:
    paths:
      - terraform/tfplan
    expire_in: 1 day
  when: manual
  allow_failure: false

# Terraform Apply (manual trigger - click to run)
terraform:apply:
  stage: apply
  image: hashicorp/terraform:1.10
  dependencies:
    - terraform:plan
  before_script:
    - cd terraform/
  script:
    - terraform apply -auto-approve tfplan
    - terraform output -json > terraform-outputs.json
  artifacts:
    paths:
      - terraform/terraform-outputs.json
    expire_in: 7 days
  when: manual
  allow_failure: false
  environment:
    name: production
    action: start

# Terraform Destroy (manual trigger - WARNING: destructive)
terraform:destroy:
  stage: destroy
  image: hashicorp/terraform:1.10
  dependencies:
    - terraform:init
  before_script:
    - cd terraform/
  script:
    - terraform destroy -auto-approve
  when: manual
  allow_failure: false
  environment:
    name: production
    action: stop

# ==============================================================================
# ANSIBLE JOBS
# ==============================================================================

# Ansible Ping (manual trigger - connectivity test)
ansible:ping:
  stage: configure
  image: cytopia/ansible:2.17-tools
  before_script:
    - cd ansible/
    - ansible-galaxy collection install -r requirements.yml
  script:
    - ansible all -m ping
  when: manual
  allow_failure: true

# Ansible PostgreSQL Playbook (manual trigger)
ansible:postgresql:
  stage: configure
  image: cytopia/ansible:2.17-tools
  dependencies:
    - terraform:apply
  before_script:
    - cd ansible/
    - ansible-galaxy collection install -r requirements.yml
  script:
    - ansible-playbook playbooks/postgresql.yml
  when: manual
  allow_failure: false
  environment:
    name: production

# Ansible GitLab Playbook (manual trigger)
ansible:gitlab:
  stage: configure
  image: cytopia/ansible:2.17-tools
  dependencies:
    - terraform:apply
  before_script:
    - cd ansible/
    - ansible-galaxy collection install -r requirements.yml
  script:
    - ansible-playbook playbooks/gitlab.yml
  when: manual
  allow_failure: false
  environment:
    name: production

# Ansible Site Playbook (manual trigger - runs ALL roles)
ansible:site:
  stage: configure
  image: cytopia/ansible:2.17-tools
  dependencies:
    - terraform:apply
  before_script:
    - cd ansible/
    - ansible-galaxy collection install -r requirements.yml
  script:
    - ansible-playbook playbooks/site.yml
  when: manual
  allow_failure: false
  environment:
    name: production

# ==============================================================================
# UTILITY JOBS
# ==============================================================================

# Update Inventory (manual trigger - fetch IPs from Terraform)
update:inventory:
  stage: plan
  image: hashicorp/terraform:1.10
  dependencies:
    - terraform:apply
  before_script:
    - cd terraform/
  script:
    - terraform output -json > ../ansible/terraform-outputs.json
    - echo "Terraform outputs saved to ansible/terraform-outputs.json"
    - echo "Manually update ansible/inventory/hosts.ini with IP addresses"
  artifacts:
    paths:
      - ansible/terraform-outputs.json
    expire_in: 7 days
  when: manual
  allow_failure: true

# ==============================================================================
# NOTES
# ==============================================================================
#
# REQUIRED GITLAB CI/CD VARIABLES:
# - PROXMOX_VE_ENDPOINT: https://192.168.40.206:8006
# - PROXMOX_VE_USERNAME: terraform@pve
# - PROXMOX_VE_PASSWORD: (masked)
# - PROXMOX_VE_INSECURE: true (for self-signed cert)
# - OP_SERVICE_ACCOUNT_TOKEN: (masked, from 1Password)
# - TF_VAR_onepassword_vault_id: (vault UUID)
#
# MANUAL JOB EXECUTION:
# 1. Navigate to CI/CD > Pipelines in GitLab
# 2. Click on the latest pipeline
# 3. Click the play button (▶) on the desired manual job
# 4. View logs in real-time
#
# TYPICAL WORKFLOW:
# 1. Edit Terraform/Ansible files, commit to git
# 2. Pipeline auto-runs: terraform:init, terraform:validate
# 3. Click ▶ on terraform:plan to preview changes
# 4. Click ▶ on terraform:apply to provision infrastructure
# 5. Click ▶ on update:inventory to get IPs
# 6. Update ansible/inventory/hosts.ini with IPs
# 7. Click ▶ on ansible:postgresql (or other playbooks)
#
# This replaces Semaphore UI with native GitLab CI/CD manual triggers
# Similar UX to Rundeck (user's prior experience at CVS)
# ==============================================================================
