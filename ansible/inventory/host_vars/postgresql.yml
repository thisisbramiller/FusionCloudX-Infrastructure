---
# ==============================================================================
# Host Variables - postgresql
# ==============================================================================
# Single PostgreSQL instance hosting MULTIPLE databases
# Container specs: 4GB RAM, 2 CPU cores, 64GB disk
# ==============================================================================

# Instance-specific PostgreSQL tuning for 4GB RAM container
# These settings are optimized for hosting multiple databases
postgresql_instance_config:
  shared_buffers: "1GB"  # ~25% of 4GB RAM
  effective_cache_size: "3GB"  # ~75% of 4GB RAM
  work_mem: "16MB"  # Conservative for multiple databases
  maintenance_work_mem: "256MB"
  max_connections: 200  # Support multiple services connecting

# ==============================================================================
# Database Configurations
# ==============================================================================
# Multiple databases on ONE instance
# ==============================================================================

# Define all databases to create
postgresql_databases:
  - name: "wazuh"
    owner: "wazuh"
    encoding: "UTF-8"
    lc_collate: "C.UTF-8"
    lc_ctype: "C.UTF-8"
    template: "template0"
    description: "Database for Wazuh (SIEM)"
  - name: "mealie"
    owner: "mealie"
    encoding: "UTF-8"
    lc_collate: "C.UTF-8"
    lc_ctype: "C.UTF-8"
    template: "template0"
    description: "Database for Mealie (Recipe Management)"
  - name: "tandoor"
    owner: "tandoor"
    encoding: "UTF-8"
    lc_collate: "C.UTF-8"
    lc_ctype: "C.UTF-8"
    template: "template0"
    description: "Database for Tandoor Recipes"

# ==============================================================================
# Database Users (with 1Password Integration)
# ==============================================================================
# Credentials are retrieved from 1Password vault "FusionCloudX Infrastructure"
# Passwords are fetched dynamically in the postgresql role (tasks/fetch-secrets.yml)
# ==============================================================================

# Note: postgresql_admin_password and postgresql_users are now populated
# dynamically by the postgresql role using onepassword.connect.field_info module
# See: ansible/roles/postgresql/tasks/fetch-secrets.yml

# ==============================================================================
# Firewall Rules
# ==============================================================================
# Allow PostgreSQL access from local network
# ==============================================================================

postgresql_firewall_rules:
  # CRITICAL: SSH must be allowed BEFORE enabling firewall to prevent lockout
  - rule: "allow"
    port: "22"
    proto: "tcp"
    comment: "SSH access (prevent firewall lockout)"
  - rule: "allow"
    port: "5432"
    proto: "tcp"
    from_ip: "192.168.0.0/16"  # Allow from local network
    comment: "PostgreSQL access from homelab network"

# ==============================================================================
# Backup Configuration
# ==============================================================================
# Centralized backup configuration for all databases
# ==============================================================================

postgresql_backup_enabled: true
postgresql_backup_retention_days: 30  # 30 days for homelab
postgresql_backup_databases:
  - wazuh
  - mealie
  - tandoor

# ==============================================================================
# Additional Notes
# ==============================================================================
# - This is a SINGLE container hosting MULTIPLE databases
# - Each service (Wazuh, etc.) gets its own database and user
# - Credentials are managed via 1Password (not ansible-vault)
# - To add a new database:
#   1. Add entry to postgresql_databases list
#   2. Add entry to postgresql_users list
#   3. Create 1Password item for the database user
#   4. Update postgresql_backup_databases list
# ==============================================================================
