---
# ==============================================================================
# Host Variables - postgresql
# ==============================================================================
# Single PostgreSQL instance hosting MULTIPLE databases
# Container specs: 4GB RAM, 2 CPU cores, 64GB disk
# ==============================================================================

# Instance-specific PostgreSQL tuning for 4GB RAM container
# These settings are optimized for hosting multiple databases
postgresql_instance_config:
  shared_buffers: "1GB"  # ~25% of 4GB RAM
  effective_cache_size: "3GB"  # ~75% of 4GB RAM
  work_mem: "16MB"  # Conservative for multiple databases
  maintenance_work_mem: "256MB"
  max_connections: 200  # Support multiple services connecting

# ==============================================================================
# Database Configurations
# ==============================================================================
# Multiple databases on ONE instance
# ==============================================================================

# Define all databases to create
postgresql_databases:
  - name: "semaphore"
    owner: "semaphore"
    encoding: "UTF-8"
    lc_collate: "en_US.UTF-8"
    lc_ctype: "en_US.UTF-8"
    template: "template0"
    description: "Database for Semaphore (Ansible UI)"

  - name: "wazuh"
    owner: "wazuh"
    encoding: "UTF-8"
    lc_collate: "en_US.UTF-8"
    lc_ctype: "en_US.UTF-8"
    template: "template0"
    description: "Database for Wazuh (SIEM)"

# ==============================================================================
# Database Users (with 1Password Integration)
# ==============================================================================
# Credentials are stored in 1Password vault "FusionCloudX Infrastructure"
# ==============================================================================

# PostgreSQL admin (postgres) user password
# Retrieved from 1Password item: "PostgreSQL Admin (postgres)"
postgresql_admin_password: "{{ lookup('onepassword.connect.generic_item', 'PostgreSQL Admin (postgres)', field='password', vault='FusionCloudX Infrastructure') }}"

# Database user configurations
postgresql_users:
  - name: "semaphore"
    password: "{{ lookup('onepassword.connect.generic_item', 'PostgreSQL - Semaphore DB User', field='password', vault='FusionCloudX Infrastructure') }}"
    database: "semaphore"
    priv: "ALL"
    role_attr_flags: "CREATEDB,NOSUPERUSER,NOCREATEROLE"
    description: "Semaphore database user"

  - name: "wazuh"
    password: "{{ lookup('onepassword.connect.generic_item', 'PostgreSQL - Wazuh DB User', field='password', vault='FusionCloudX Infrastructure') }}"
    database: "wazuh"
    priv: "ALL"
    role_attr_flags: "CREATEDB,NOSUPERUSER,NOCREATEROLE"
    description: "Wazuh database user"

# ==============================================================================
# Firewall Rules
# ==============================================================================
# Allow PostgreSQL access from local network
# ==============================================================================

postgresql_firewall_rules:
  - rule: "allow"
    port: "5432"
    proto: "tcp"
    from_ip: "192.168.0.0/16"  # Allow from local network
    comment: "PostgreSQL access from homelab network"

# ==============================================================================
# Backup Configuration
# ==============================================================================
# Centralized backup configuration for all databases
# ==============================================================================

postgresql_backup_enabled: true
postgresql_backup_retention_days: 30  # 30 days for homelab
postgresql_backup_databases:
  - semaphore
  - wazuh

# ==============================================================================
# Additional Notes
# ==============================================================================
# - This is a SINGLE container hosting MULTIPLE databases
# - Each service (Semaphore, Wazuh) gets its own database and user
# - Credentials are managed via 1Password (not ansible-vault)
# - To add a new database:
#   1. Add entry to postgresql_databases list
#   2. Add entry to postgresql_users list
#   3. Create 1Password item for the database user
#   4. Update postgresql_backup_databases list
# ==============================================================================
