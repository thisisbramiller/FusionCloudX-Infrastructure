---
# ==============================================================================
# PostgreSQL Group Variables
# ==============================================================================
# Shared configuration for the PostgreSQL database server
# Note: This is a SINGLE container hosting MULTIPLE databases
# ==============================================================================

# PostgreSQL Version
postgresql_version: "15"  # Debian 12 default is PostgreSQL 15

# PostgreSQL Global Configuration
postgresql_global_config:
  # Connection Settings
  listen_addresses: "'*'"  # Listen on all interfaces (firewall controls access)
  port: 5432
  max_connections: 200  # Increased for multiple services

  # Memory Settings (optimized for 4GB RAM container with multiple databases)
  shared_buffers: "1GB"  # ~25% of 4GB RAM
  effective_cache_size: "3GB"  # ~75% of 4GB RAM
  work_mem: "16MB"  # Conservative for multiple concurrent queries
  maintenance_work_mem: "256MB"

  # WAL Settings
  wal_buffers: "16MB"  # Increased for multiple databases
  max_wal_size: "2GB"  # Increased for multiple databases
  min_wal_size: "512MB"

  # Query Planning
  random_page_cost: 4.0
  effective_io_concurrency: 2

  # Logging
  logging_collector: "on"
  log_directory: "'/var/log/postgresql'"
  log_filename: "'postgresql-%Y-%m-%d_%H%M%S.log'"
  log_rotation_age: "1d"
  log_rotation_size: "100MB"
  log_line_prefix: "'%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '"
  log_timezone: "'America/Chicago'"

  # Locale
  datestyle: "'iso, mdy'"
  timezone: "'America/Chicago'"
  lc_messages: "'C.UTF-8'"
  lc_monetary: "'C.UTF-8'"
  lc_numeric: "'C.UTF-8'"
  lc_time: "'C.UTF-8'"
  default_text_search_config: "'pg_catalog.english'"

# PostgreSQL Authentication (pg_hba.conf)
postgresql_hba_entries:
  # Local connections
  - type: "local"
    database: "all"
    user: "all"
    method: "peer"

  # IPv4 local connections
  - type: "host"
    database: "all"
    user: "all"
    address: "127.0.0.1/32"
    method: "scram-sha-256"

  # IPv6 local connections
  - type: "host"
    database: "all"
    user: "all"
    address: "::1/128"
    method: "scram-sha-256"

  # Allow connections from local network (homelab)
  - type: "host"
    database: "all"
    user: "all"
    address: "192.168.0.0/16"
    method: "scram-sha-256"

# Default Admin User (postgres superuser)
postgresql_admin_user: "postgres"
# Password is retrieved from 1Password (see host_vars/postgresql.yml)

# Packages to install
postgresql_packages:
  - "postgresql-{{ postgresql_version }}"
  - "postgresql-contrib-{{ postgresql_version }}"
  - "postgresql-client-{{ postgresql_version }}"
  - "python3-psycopg2"  # Required for Ansible PostgreSQL modules

# Service name
postgresql_service_name: "postgresql"

# Data directory
postgresql_data_directory: "/var/lib/postgresql/{{ postgresql_version }}/main"

# Configuration files
postgresql_conf_path: "/etc/postgresql/{{ postgresql_version }}/main/postgresql.conf"
postgresql_hba_path: "/etc/postgresql/{{ postgresql_version }}/main/pg_hba.conf"

# ==============================================================================
# Important Notes
# ==============================================================================
# - This configuration is for a SINGLE PostgreSQL instance
# - The instance hosts MULTIPLE databases (semaphore, wazuh, etc.)
# - Tuning is balanced for multiple concurrent services
# - Per-database configuration is in host_vars/postgresql.yml
# - Credentials are managed via 1Password lookups
# ==============================================================================
