# GitLab Role

Ansible role for deploying and configuring GitLab Community Edition (CE) with HTTPS support using FusionCloudX PKI certificates.

## Overview

This role deploys GitLab Omnibus CE with:
- HTTPS support using FusionCloudX wildcard certificates
- Memory-optimized configuration for homelab environments (8GB RAM)
- Automatic HTTP â†’ HTTPS redirect
- Modern TLS security (TLSv1.2, TLSv1.3)
- HSTS security headers
- Automated HTTPS endpoint verification

## Requirements

### Dependencies

- **Certificates Role**: Must run before GitLab configuration
  - Deploys FusionCloudX certificates to standard system paths
  - Certificates generated by `fusioncloudx-bootstrap` Phase 04
  - Retrieved from 1Password vault

### System Requirements

- **OS**: Ubuntu 22.04 LTS (Jammy)
- **RAM**: 8GB minimum (role optimized for memory-constrained environments)
- **Disk**: 20GB+ for GitLab data
- **Network**: Ports 80 (HTTP), 443 (HTTPS), 22 (SSH)

## Role Variables

### Core Configuration

```yaml
# GitLab edition and version
gitlab_edition: "gitlab-ce"  # Community Edition
gitlab_version: ""           # Empty = latest version

# Domain configuration
gitlab_domain: "fusioncloudx.home"
gitlab_hostname: "gitlab"
gitlab_enable_https: true    # Enable/disable HTTPS configuration
gitlab_external_url: "{{ 'https' if gitlab_enable_https else 'http' }}://{{ gitlab_hostname }}.{{ gitlab_domain }}"
```

### SSL/TLS Configuration

```yaml
# Certificate paths (deployed by certificates role)
gitlab_ssl_certificate: "/etc/ssl/certs/server.crt"
gitlab_ssl_certificate_key: "/etc/ssl/private/server.key"

# TLS protocols and ciphers
gitlab_ssl_protocols: "TLSv1.2 TLSv1.3"
gitlab_ssl_ciphers: "ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256"
gitlab_ssl_prefer_server_ciphers: "on"

# HSTS (HTTP Strict Transport Security) configuration
gitlab_hsts_max_age: 31536000        # 1 year in seconds
gitlab_hsts_include_subdomains: false
```

### Memory-Constrained Configuration

```yaml
# Optimize for 8GB RAM homelab environments
gitlab_memory_constrained: true
gitlab_puma_workers: 0               # Single process mode (saves ~300MB)
gitlab_sidekiq_concurrency: 10       # Reduced background job concurrency
gitlab_prometheus_enabled: false     # Disable monitoring (saves ~200MB)
```

### Email Configuration

```yaml
gitlab_email_enabled: true
gitlab_email_from: "gitlab@{{ gitlab_domain }}"
gitlab_email_display_name: "GitLab"
```

### Backup Configuration

```yaml
gitlab_backup_enabled: true
gitlab_backup_path: "/var/opt/gitlab/backups"
gitlab_backup_keep_time: 604800      # 7 days in seconds
```

## Usage

### Basic Deployment

Deploy GitLab with HTTPS (requires certificates role):

```bash
# Full deployment (certificates + GitLab)
ansible-playbook ansible/playbooks/site.yml --limit gitlab

# GitLab only (assumes certificates already deployed)
ansible-playbook ansible/playbooks/gitlab.yml --limit gitlab
```

### Enable/Disable HTTPS

```yaml
# ansible/inventory/host_vars/gitlab.yml
gitlab_enable_https: false  # Disable HTTPS, use HTTP only
```

After changing, reconfigure:

```bash
ansible-playbook ansible/playbooks/gitlab.yml --limit gitlab
```

### Custom HSTS Configuration

```yaml
# ansible/inventory/host_vars/gitlab.yml
gitlab_hsts_max_age: 15768000        # 6 months for testing
gitlab_hsts_include_subdomains: true # Enable for production
```

### Selective Task Execution

```bash
# Run only HTTPS verification
ansible-playbook ansible/playbooks/gitlab.yml --limit gitlab --tags verify

# Configure GitLab without verification
ansible-playbook ansible/playbooks/gitlab.yml --limit gitlab --tags configure

# HTTPS-specific tasks only
ansible-playbook ansible/playbooks/gitlab.yml --limit gitlab --tags https
```

## Architecture

### GitLab Omnibus Native HTTPS

This role uses GitLab Omnibus' built-in nginx for HTTPS:
- Setting `external_url` to `https://` triggers automatic HTTPS configuration
- GitLab manages nginx SSL configuration internally
- No external reverse proxy required
- Automatic HTTP â†’ HTTPS redirect

### Certificate Integration

```
fusioncloudx-bootstrap Phase 04
  â””â”€> Generates *.fusioncloudx.home wildcard certificate
      â””â”€> Stored in 1Password vault
          â””â”€> Certificates role deploys to system paths
              â””â”€> GitLab role configures Omnibus to use certificates
```

## Troubleshooting

### SSL Certificate Not Found

**Error:**
```
TASK [Display helpful error if certificates are missing]
fatal: [gitlab]: FAILED! =>
  msg: |-
    SSL certificate not found: /etc/ssl/certs/server.crt

    Please ensure the certificates role has been run first:
    ansible-playbook ansible/playbooks/common.yml --limit gitlab
```

**Solution:**
1. Verify certificates role has been applied:
   ```bash
   ssh gitlab "ls -la /etc/ssl/certs/server.crt /etc/ssl/private/server.key"
   ```

2. If missing, run certificates role:
   ```bash
   ansible-playbook ansible/playbooks/common.yml --limit gitlab
   ```

3. If still missing, check 1Password integration:
   - Verify `op` CLI authenticated: `op account list`
   - Check certificate exists in vault: `op item get "FusionCloudX Wildcard Certificate"`

### GitLab Not Responding After Configuration

**Symptoms:**
- Port 443 not listening
- GitLab services not running
- HTTPS verification fails

**Diagnosis:**
```bash
# Check GitLab services
ssh gitlab 'sudo gitlab-ctl status'

# Check nginx logs
ssh gitlab 'sudo gitlab-ctl tail nginx'

# Check GitLab configuration logs
ssh gitlab 'sudo gitlab-ctl reconfigure'

# Verify port listening
ssh gitlab 'sudo netstat -tlnp | grep 443'
```

**Common Issues:**
1. **Configuration Syntax Error**:
   - Check `/etc/gitlab/gitlab.rb` for syntax errors
   - Run: `ssh gitlab 'sudo gitlab-ctl reconfigure'`

2. **Firewall Blocking**:
   - Verify firewall rules: `ssh gitlab 'sudo ufw status'`
   - Expected: Allow 80/tcp, 443/tcp, 22/tcp

3. **Memory Issues**:
   - Check available RAM: `ssh gitlab 'free -h'`
   - GitLab requires minimum 8GB RAM
   - Consider reducing `gitlab_sidekiq_concurrency` further

### HSTS Too Aggressive

**Problem:** Browser won't allow HTTP access after HSTS enabled

**Solution:** Reset HSTS in browser or adjust max-age:
```yaml
# ansible/inventory/host_vars/gitlab.yml
gitlab_hsts_max_age: 300  # 5 minutes for testing
```

Reconfigure and wait for HSTS to expire in browser.

### Certificate Trust Issues

**Symptoms:**
- Browser shows "Not Secure" warning
- Git operations fail with SSL errors

**Solution:**
1. Verify certificate deployed:
   ```bash
   echo | openssl s_client -connect gitlab.fusioncloudx.home:443 -servername gitlab.fusioncloudx.home 2>/dev/null | grep -E "subject=|issuer="
   ```

2. Check certificate matches domain:
   ```
   subject=C=US, ST=State, L=City, O=FusionCloudX, OU=DevOps, CN=*.fusioncloudx.home
   ```

3. Install CA certificate on client machines:
   - macOS: Add to Keychain Access
   - Linux: Copy to `/usr/local/share/ca-certificates/` and run `update-ca-certificates`
   - Windows: Import to Trusted Root Certification Authorities

### Automated Verification Fails

**Error:**
```
TASK [Verify HTTPS endpoint responding]
fatal: [gitlab]: FAILED! =>
  msg: Status code was -1 and not [200, 302]: Request failed: <urlopen error [Errno 111] Connection refused>
```

**Solution:**
1. Increase `wait_for` timeout in `configure.yml` (default: 300s)
2. Check GitLab startup logs: `ssh gitlab 'sudo gitlab-ctl tail'`
3. Manually verify: `curl -I https://gitlab.fusioncloudx.home`
4. Skip verification: `--skip-tags verify`

## Testing & Verification

### Manual HTTPS Testing

```bash
# Test HTTPS access
curl -I https://gitlab.fusioncloudx.home
# Expected: HTTP/2 302 (redirect to login)

# Test HTTP â†’ HTTPS redirect
curl -I http://gitlab.fusioncloudx.home
# Expected: HTTP/1.1 301 â†’ https://gitlab.fusioncloudx.home:443/

# Verify certificate
echo | openssl s_client -connect gitlab.fusioncloudx.home:443 -servername gitlab.fusioncloudx.home 2>/dev/null | grep -E "subject=|issuer="
# Expected: *.fusioncloudx.home certificate

# Test TLS version
nmap --script ssl-enum-ciphers -p 443 gitlab.fusioncloudx.home
# Expected: TLSv1.2, TLSv1.3 only

# Test Git operations
git clone https://gitlab.fusioncloudx.home/test/project.git /tmp/test-clone
# Expected: Success without certificate errors
```

### Automated Verification

```bash
# Run built-in HTTPS verification
ansible-playbook ansible/playbooks/gitlab.yml --limit gitlab --tags verify

# Expected output:
# TASK [Verify HTTPS endpoint responding] ***************************************
# ok: [gitlab] => (item=https://gitlab.fusioncloudx.home)
#
# TASK [Display HTTPS verification result] **************************************
# ok: [gitlab] =>
#   msg: âœ… GitLab HTTPS endpoint verified: 302
```

## File Structure

```
ansible/roles/gitlab/
â”œâ”€â”€ README.md                    # This file
â”œâ”€â”€ defaults/
â”‚   â””â”€â”€ main.yml                 # Default variables
â”œâ”€â”€ handlers/
â”‚   â””â”€â”€ main.yml                 # Service handlers (reconfigure gitlab)
â”œâ”€â”€ tasks/
â”‚   â”œâ”€â”€ main.yml                 # Main task orchestration
â”‚   â”œâ”€â”€ install.yml              # Package installation
â”‚   â””â”€â”€ configure.yml            # Configuration and verification
â””â”€â”€ templates/
    â””â”€â”€ gitlab.rb.j2             # GitLab Omnibus configuration template
```

## Related Documentation

- **FusionCloudX Bootstrap**: Certificate generation (Phase 04)
- **Certificates Role**: Certificate deployment (`ansible/roles/certificates/`)
- **Common Playbook**: Shared role application (`ansible/playbooks/common.yml`)
- **GitLab Documentation**: https://docs.gitlab.com/omnibus/

## Migration Notes

### Switching from HTTP to HTTPS

1. Update configuration:
   ```yaml
   # ansible/inventory/host_vars/gitlab.yml
   gitlab_enable_https: true
   ```

2. Deploy certificates and reconfigure:
   ```bash
   ansible-playbook ansible/playbooks/site.yml --limit gitlab
   ```

3. Update Git remotes in local repositories:
   ```bash
   git remote set-url origin https://gitlab.fusioncloudx.home/namespace/project.git
   ```

4. Update browser bookmarks (HTTP URLs will redirect automatically)

### Switching from HTTPS to HTTP

1. Update configuration:
   ```yaml
   # ansible/inventory/host_vars/gitlab.yml
   gitlab_enable_https: false
   ```

2. Reconfigure:
   ```bash
   ansible-playbook ansible/playbooks/gitlab.yml --limit gitlab
   ```

3. Wait for HSTS to expire in browsers, or clear browser HSTS cache

## Security Best Practices

### Implemented by Role

- âœ… Modern TLS protocols only (TLSv1.2, TLSv1.3)
- âœ… Strong cipher suites with forward secrecy
- âœ… HSTS headers (1 year max-age by default)
- âœ… Automatic HTTP â†’ HTTPS redirect
- âœ… Certificate validation before deployment
- âœ… Backup enabled by default (7 day retention)

### Additional Recommendations

1. **Root Password**: Change GitLab root password immediately after first login
2. **SSH Keys**: Use SSH keys for Git operations (not HTTPS passwords)
3. **2FA**: Enable two-factor authentication for all users
4. **Updates**: Regularly update GitLab to latest stable version
5. **Backups**: Test backup restoration regularly
6. **Monitoring**: Consider enabling Prometheus for production use

## Performance Optimization

### Default Configuration (8GB RAM)

The role is pre-configured for homelab environments with 8GB RAM:
- Puma workers: 0 (single process mode)
- Sidekiq concurrency: 10
- Prometheus disabled
- Supports 1-10 users comfortably

### Scaling for More Users

For 10+ users or 16GB+ RAM:

```yaml
# ansible/inventory/host_vars/gitlab.yml
gitlab_puma_workers: 2           # Enable multi-process
gitlab_sidekiq_concurrency: 20   # Increase background jobs
gitlab_prometheus_enabled: true  # Enable monitoring
```

### Further Memory Reduction

For 4GB RAM (not recommended):

```yaml
# ansible/inventory/host_vars/gitlab.yml
gitlab_puma_workers: 0
gitlab_sidekiq_concurrency: 5
gitlab_prometheus_enabled: false
```

## Changelog

### Version 1.1.0 (2026-02-02)
- âœ¨ Added better error messages for missing certificates
- âœ¨ Added automated HTTPS endpoint verification
- âœ¨ Parameterized HSTS configuration
- ğŸ“ Created comprehensive role documentation

### Version 1.0.0 (2026-02-02)
- ğŸ‰ Initial release with HTTPS support
- âœ… FusionCloudX certificate integration
- âœ… Memory-optimized configuration
- âœ… Automatic HTTP â†’ HTTPS redirect

---

**Maintained by**: FusionCloudX Infrastructure Team
**Last Updated**: 2026-02-02
