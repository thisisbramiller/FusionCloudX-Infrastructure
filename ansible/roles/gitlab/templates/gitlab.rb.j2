# ==============================================================================
# GitLab Omnibus Configuration
# ==============================================================================
# Generated by Ansible - Do not edit manually
# ==============================================================================

# External URL
external_url '{{ gitlab_external_url }}'

{% if gitlab_enable_https %}
# ==============================================================================
# HTTPS/SSL Configuration
# ==============================================================================
# Configures nginx (built into GitLab Omnibus) to use FusionCloudX certificates
# Certificates deployed by certificates role to standard system paths
# ==============================================================================

# SSL Certificate paths
nginx['ssl_certificate'] = "{{ gitlab_ssl_certificate }}"
nginx['ssl_certificate_key'] = "{{ gitlab_ssl_certificate_key }}"

# SSL/TLS protocols and ciphers (modern, secure configuration)
nginx['ssl_protocols'] = "{{ gitlab_ssl_protocols }}"
nginx['ssl_ciphers'] = "{{ gitlab_ssl_ciphers }}"
nginx['ssl_prefer_server_ciphers'] = "{{ gitlab_ssl_prefer_server_ciphers }}"

# Redirect HTTP to HTTPS
nginx['redirect_http_to_https'] = true

# Enable HSTS (HTTP Strict Transport Security)
nginx['hsts_max_age'] = 31536000
nginx['hsts_include_subdomains'] = false
{% endif %}

{% if gitlab_memory_constrained %}
# ==============================================================================
# Memory-Constrained Configuration
# ==============================================================================
# Optimized for homelab with 8GB RAM (supports 1-10 users)
# ==============================================================================

# Puma (application server) - single process mode
puma['worker_processes'] = {{ gitlab_puma_workers }}

# Sidekiq (background jobs) - reduced concurrency
sidekiq['concurrency'] = {{ gitlab_sidekiq_concurrency }}

# Disable Prometheus monitoring to save ~200MB RAM
prometheus_monitoring['enable'] = {{ gitlab_prometheus_enabled | lower }}

# Configure jemalloc for aggressive memory release
gitlab_rails['env'] = {
  'MALLOC_CONF' => 'dirty_decay_ms:1000,muzzy_decay_ms:1000'
}
{% endif %}

# ==============================================================================
# Email Configuration
# ==============================================================================
{% if gitlab_email_enabled %}
gitlab_rails['gitlab_email_enabled'] = true
gitlab_rails['gitlab_email_from'] = '{{ gitlab_email_from }}'
gitlab_rails['gitlab_email_display_name'] = '{{ gitlab_email_display_name }}'
gitlab_rails['smtp_enable'] = true
gitlab_rails['smtp_address'] = "localhost"
gitlab_rails['smtp_port'] = 25
gitlab_rails['smtp_domain'] = '{{ gitlab_domain }}'
{% endif %}

# ==============================================================================
# Backup Configuration
# ==============================================================================
{% if gitlab_backup_enabled %}
gitlab_rails['backup_path'] = '{{ gitlab_backup_path }}'
gitlab_rails['backup_keep_time'] = {{ gitlab_backup_keep_time }}
{% endif %}

# ==============================================================================
# Database Configuration
# ==============================================================================
# Use embedded PostgreSQL (managed by Omnibus)
postgresql['enable'] = true

# ==============================================================================
# GitLab Pages (disabled for homelab)
# ==============================================================================
gitlab_pages['enable'] = false
