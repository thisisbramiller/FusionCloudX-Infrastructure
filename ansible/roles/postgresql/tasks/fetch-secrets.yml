---
# ==============================================================================
# Fetch Secrets from 1Password
# ==============================================================================
# Retrieves database passwords from 1Password Connect Server
# Uses official onepassword.connect collection pattern
# ==============================================================================

- name: Set Connect token variable (best practice per 1Password docs)
  set_fact:
    connect_token: "{{ lookup('env', 'OP_CONNECT_TOKEN') }}"
  no_log: true
  tags: ['postgresql', 'secrets']

- name: Set vault ID variable
  set_fact:
    vault_id: "{{ lookup('env', 'TF_VAR_onepassword_vault_id') }}"
  tags: ['postgresql', 'secrets']

- name: Retrieve PostgreSQL admin (postgres) password from 1Password
  onepassword.connect.field_info:
    token: "{{ connect_token }}"
    item: "PostgreSQL Admin (postgres)"
    field: "password"
    vault: "{{ vault_id }}"
  environment:
    OP_CONNECT_HOST: "{{ lookup('env', 'OP_CONNECT_HOST') }}"
  delegate_to: localhost
  become: no
  no_log: true
  register: postgres_admin_password_result
  tags: ['postgresql', 'secrets']

- name: Set PostgreSQL admin password variable
  set_fact:
    postgresql_admin_password: "{{ postgres_admin_password_result.field.value }}"
  no_log: true
  tags: ['postgresql', 'secrets']

- name: Retrieve Wazuh database user password from 1Password
  onepassword.connect.field_info:
    token: "{{ connect_token }}"
    item: "PostgreSQL - Wazuh Database User"
    field: "password"
    vault: "{{ vault_id }}"
  environment:
    OP_CONNECT_HOST: "{{ lookup('env', 'OP_CONNECT_HOST') }}"
  delegate_to: localhost
  become: no
  no_log: true
  register: wazuh_db_password_result
  tags: ['postgresql', 'secrets']

- name: Retrieve Mealie database user password from 1Password
  onepassword.connect.field_info:
    token: "{{ connect_token }}"
    item: "PostgreSQL - Mealie Database User"
    field: "password"
    vault: "{{ vault_id }}"
  environment:
    OP_CONNECT_HOST: "{{ lookup('env', 'OP_CONNECT_HOST') }}"
  delegate_to: localhost
  become: no
  no_log: true
  register: mealie_db_password_result
  tags: ['postgresql', 'secrets']

- name: Retrieve Tandoor database user password from 1Password
  onepassword.connect.field_info:
    token: "{{ connect_token }}"
    item: "PostgreSQL - Tandoor Database User"
    field: "password"
    vault: "{{ vault_id }}"
  environment:
    OP_CONNECT_HOST: "{{ lookup('env', 'OP_CONNECT_HOST') }}"
  delegate_to: localhost
  become: no
  no_log: true
  register: tandoor_db_password_result
  tags: ['postgresql', 'secrets']

- name: Build PostgreSQL users list with retrieved passwords
  set_fact:
    postgresql_users:
      - name: "wazuh"
        password: "{{ wazuh_db_password_result.field.value }}"
        database: "wazuh"
        priv: "ALL"
        role_attr_flags: "CREATEDB,NOSUPERUSER,NOCREATEROLE"
        description: "Wazuh database user"
      - name: "mealie"
        password: "{{ mealie_db_password_result.field.value }}"
        database: "mealie"
        priv: "ALL"
        role_attr_flags: "CREATEDB,NOSUPERUSER,NOCREATEROLE"
        description: "Mealie database user"
      - name: "tandoor"
        password: "{{ tandoor_db_password_result.field.value }}"
        database: "tandoor"
        priv: "ALL"
        role_attr_flags: "CREATEDB,NOSUPERUSER,NOCREATEROLE"
        description: "Tandoor database user"
  no_log: true
  tags: ['postgresql', 'secrets']

- name: Display secret retrieval status
  debug:
    msg:
      - "Successfully retrieved secrets from 1Password"
      - "Admin password: retrieved ✓"
      - "Wazuh user password: retrieved ✓"
      - "Mealie user password: retrieved ✓"
      - "Tandoor user password: retrieved ✓"
  tags: ['postgresql', 'secrets']
