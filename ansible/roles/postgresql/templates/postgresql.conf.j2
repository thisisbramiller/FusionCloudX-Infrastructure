# ==============================================================================
# PostgreSQL Configuration File
# ==============================================================================
# Generated by Ansible - DO NOT EDIT MANUALLY
# Managed by: roles/postgresql/templates/postgresql.conf.j2
# ==============================================================================

#------------------------------------------------------------------------------
# CONNECTIONS AND AUTHENTICATION
#------------------------------------------------------------------------------

# Connection Settings
{% set config = postgresql_global_config | combine(postgresql_instance_config | default({})) %}
listen_addresses = {{ config.listen_addresses | default("'localhost'") }}
port = {{ config.port | default(5432) }}
max_connections = {{ config.max_connections | default(100) }}

# Superuser reserved connections
superuser_reserved_connections = 3

#------------------------------------------------------------------------------
# RESOURCE USAGE (except WAL)
#------------------------------------------------------------------------------

# Memory
shared_buffers = {{ config.shared_buffers | default('128MB') }}
huge_pages = try
work_mem = {{ config.work_mem | default('4MB') }}
maintenance_work_mem = {{ config.maintenance_work_mem | default('64MB') }}
effective_cache_size = {{ config.effective_cache_size | default('4GB') }}

# Kernel Resource Usage
max_files_per_process = 1000

#------------------------------------------------------------------------------
# WRITE-AHEAD LOG
#------------------------------------------------------------------------------

# Settings
wal_buffers = {{ config.wal_buffers | default('-1') }}
max_wal_size = {{ config.max_wal_size | default('1GB') }}
min_wal_size = {{ config.min_wal_size | default('80MB') }}

# Checkpoints
checkpoint_completion_target = 0.9

#------------------------------------------------------------------------------
# QUERY TUNING
#------------------------------------------------------------------------------

# Planner Cost Constants
random_page_cost = {{ config.random_page_cost | default('4.0') }}
effective_io_concurrency = {{ config.effective_io_concurrency | default('1') }}

#------------------------------------------------------------------------------
# ERROR REPORTING AND LOGGING
#------------------------------------------------------------------------------

# Where to Log
logging_collector = {{ config.logging_collector | default('on') }}
log_directory = {{ config.log_directory | default("'/var/log/postgresql'") }}
log_filename = {{ config.log_filename | default("'postgresql-%Y-%m-%d_%H%M%S.log'") }}

# When to Log
log_min_duration_statement = -1

# What to Log
log_line_prefix = {{ config.log_line_prefix | default("'%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '") }}
log_timezone = {{ config.log_timezone | default("'UTC'") }}

# Log Rotation
log_rotation_age = {{ config.log_rotation_age | default('1d') }}
log_rotation_size = {{ config.log_rotation_size | default('10MB') }}

#------------------------------------------------------------------------------
# CLIENT CONNECTION DEFAULTS
#------------------------------------------------------------------------------

# Locale and Formatting
datestyle = {{ config.datestyle | default("'iso, mdy'") }}
timezone = {{ config.timezone | default("'UTC'") }}

# These settings are initialized by initdb, but they can be changed.
lc_messages = {{ config.lc_messages | default("'en_US.UTF-8'") }}
lc_monetary = {{ config.lc_monetary | default("'en_US.UTF-8'") }}
lc_numeric = {{ config.lc_numeric | default("'en_US.UTF-8'") }}
lc_time = {{ config.lc_time | default("'en_US.UTF-8'") }}

# default configuration for text search
default_text_search_config = {{ config.default_text_search_config | default("'pg_catalog.english'") }}

#------------------------------------------------------------------------------
# STATISTICS
#------------------------------------------------------------------------------

# Query and Index Statistics Collector
track_activities = on
track_counts = on
track_io_timing = off
track_functions = none

# Statistics Monitoring
stats_temp_directory = '/var/run/postgresql/{{ postgresql_version }}-main.pg_stat_tmp'

#------------------------------------------------------------------------------
# AUTOVACUUM
#------------------------------------------------------------------------------

autovacuum = on
log_autovacuum_min_duration = -1
autovacuum_max_workers = 3
autovacuum_naptime = 1min

#------------------------------------------------------------------------------
# VERSION AND PLATFORM COMPATIBILITY
#------------------------------------------------------------------------------

# Previous PostgreSQL Versions
array_nulls = on

#------------------------------------------------------------------------------
# CUSTOM SETTINGS (if needed)
#------------------------------------------------------------------------------

# Add any custom configuration below
{% if postgresql_custom_config is defined %}
{% for key, value in postgresql_custom_config.items() %}
{{ key }} = {{ value }}
{% endfor %}
{% endif %}
