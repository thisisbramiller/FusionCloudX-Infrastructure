---
# ==============================================================================
# Install 1Password CLI
# ==============================================================================
# Installs 1Password CLI for secrets management
# Supports both Service Account Token and Connect Server
# ==============================================================================

- name: Check if 1Password CLI is already installed
  ansible.builtin.command: op --version
  register: op_version_check
  changed_when: false
  failed_when: false

- name: Display current 1Password CLI version
  ansible.builtin.debug:
    msg: "1Password CLI is already installed: {{ op_version_check.stdout }}"
  when: op_version_check.rc == 0

- name: Install 1Password CLI
  when: op_version_check.rc != 0 or op_version_check.stdout is not search(onepassword_cli_version)
  block:
    - name: Create temporary download directory
      ansible.builtin.tempfile:
        state: directory
        suffix: op-cli
      register: temp_dir

    - name: Download 1Password CLI
      ansible.builtin.get_url:
        url: "{{ onepassword_cli_url }}"
        dest: "{{ temp_dir.path }}/op.zip"
        mode: '0644'

    - name: Unzip 1Password CLI
      ansible.builtin.unarchive:
        src: "{{ temp_dir.path }}/op.zip"
        dest: "{{ temp_dir.path }}"
        remote_src: true

    - name: Install 1Password CLI binary
      ansible.builtin.copy:
        src: "{{ temp_dir.path }}/op"
        dest: "{{ onepassword_cli_install_path }}/op"
        mode: '0755'
        remote_src: true
      become: true

    - name: Clean up temporary files
      ansible.builtin.file:
        path: "{{ temp_dir.path }}"
        state: absent

- name: Verify 1Password CLI installation
  ansible.builtin.command: op --version
  register: op_verify
  changed_when: false

- name: Display 1Password CLI version
  ansible.builtin.debug:
    msg: "1Password CLI version: {{ op_verify.stdout }}"

# ==============================================================================
# Configure 1Password CLI
# ==============================================================================

- name: Create 1Password config directory
  ansible.builtin.file:
    path: "{{ ansible_user_home }}/.config/op"
    state: directory
    owner: "{{ ansible_user_name }}"
    group: "{{ ansible_user_name }}"
    mode: '0700'
  become: true

- name: Configure 1Password CLI for service account
  ansible.builtin.debug:
    msg:
      - "1Password CLI is installed"
      - "Set the OP_SERVICE_ACCOUNT_TOKEN environment variable to authenticate"
      - "This will be configured in the environment configuration step"

# ==============================================================================
# Test 1Password Connection (if token provided)
# ==============================================================================

- name: Test 1Password connection
  ansible.builtin.command: op vault list
  environment:
    OP_SERVICE_ACCOUNT_TOKEN: "{{ environment_vars.OP_SERVICE_ACCOUNT_TOKEN }}"
  register: op_test
  changed_when: false
  failed_when: false
  become: true
  become_user: "{{ ansible_user_name }}"
  when: environment_vars.OP_SERVICE_ACCOUNT_TOKEN != ''

- name: Display 1Password vaults
  ansible.builtin.debug:
    msg: "{{ op_test.stdout_lines }}"
  when:
    - op_test.rc is defined
    - op_test.rc == 0

- name: Warning if 1Password connection failed
  ansible.builtin.debug:
    msg:
      - "WARNING: Could not connect to 1Password"
      - "Make sure OP_SERVICE_ACCOUNT_TOKEN is set correctly"
      - "You can test manually: op vault list"
  when:
    - op_test.rc is defined
    - op_test.rc != 0
