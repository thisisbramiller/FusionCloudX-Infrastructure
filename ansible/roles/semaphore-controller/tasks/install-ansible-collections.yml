---
# ==============================================================================
# Install Ansible Collections
# ==============================================================================
# Installs required Ansible collections for infrastructure management
# ==============================================================================

- name: Install Ansible collections from requirements file
  ansible.builtin.command: >
    ansible-galaxy collection install -r {{ infra_repo_path }}/ansible/requirements.yml --force
  become: true
  become_user: "{{ ansible_user_name }}"
  when: infra_repo_path is defined
  changed_when: true
  register: collections_from_file
  failed_when: false

- name: Install Ansible collections from defaults
  community.general.ansible_galaxy_install:
    type: collection
    name: "{{ item.name }}"
    version: "{{ item.version | default(omit) }}"
  loop: "{{ ansible_collections }}"
  become: true
  become_user: "{{ ansible_user_name }}"
  when: collections_from_file.rc != 0 or collections_from_file.rc is not defined

- name: List installed Ansible collections
  ansible.builtin.command: ansible-galaxy collection list
  become: true
  become_user: "{{ ansible_user_name }}"
  register: installed_collections
  changed_when: false

- name: Display installed collections
  ansible.builtin.debug:
    msg: "{{ installed_collections.stdout_lines }}"
