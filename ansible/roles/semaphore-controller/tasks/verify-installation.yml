---
# ==============================================================================
# Verify Installation
# ==============================================================================
# Verifies all components are installed and working correctly
# ==============================================================================

- name: Verify Ansible installation
  ansible.builtin.command: ansible --version
  register: ansible_verify
  changed_when: false
  become: true
  become_user: "{{ ansible_user_name }}"

- name: Verify Terraform installation
  ansible.builtin.command: terraform version
  register: terraform_verify_final
  changed_when: false

- name: Verify 1Password CLI installation
  ansible.builtin.command: op --version
  register: op_verify_final
  changed_when: false

- name: Verify Git installation
  ansible.builtin.command: git --version
  register: git_verify
  changed_when: false

- name: Verify Semaphore installation
  ansible.builtin.command: "{{ semaphore_install_path }}/semaphore version"
  register: semaphore_verify
  changed_when: false

- name: Check Semaphore service status
  ansible.builtin.systemd:
    name: semaphore
  register: semaphore_service_status
  become: true

- name: Verify repository exists
  ansible.builtin.stat:
    path: "{{ infra_repo_path }}/.git"
  register: repo_verify

- name: Verify SSH keys exist
  ansible.builtin.stat:
    path: "{{ item }}"
  loop:
    - "{{ ssh_management_key_path }}"
    - "{{ ssh_github_deploy_key_path }}"
    - "{{ ssh_proxmox_key_path }}"
  register: ssh_keys_verify

- name: Display verification summary
  ansible.builtin.debug:
    msg:
      - "=========================================="
      - "INSTALLATION VERIFICATION"
      - "=========================================="
      - ""
      - "✓ Ansible: {{ ansible_verify.stdout_lines[0] }}"
      - "✓ Terraform: {{ terraform_verify_final.stdout_lines[0] }}"
      - "✓ 1Password CLI: v{{ op_verify_final.stdout }}"
      - "✓ Git: {{ git_verify.stdout }}"
      - "✓ Semaphore: {{ semaphore_verify.stdout }}"
      - ""
      - "Services:"
      - "  Semaphore: {{ semaphore_service_status.status.ActiveState }}"
      - ""
      - "Repository:"
      - "  Exists: {{ 'Yes' if repo_verify.stat.exists else 'No' }}"
      - "  Path: {{ infra_repo_path }}"
      - ""
      - "SSH Keys:"
      - "  Management: {{ 'Yes' if ssh_keys_verify.results[0].stat.exists else 'No' }}"
      - "  GitHub: {{ 'Yes' if ssh_keys_verify.results[1].stat.exists else 'No' }}"
      - "  Proxmox: {{ 'Yes' if ssh_keys_verify.results[2].stat.exists else 'No' }}"
      - ""
      - "=========================================="
      - "All components installed successfully!"
      - "=========================================="
