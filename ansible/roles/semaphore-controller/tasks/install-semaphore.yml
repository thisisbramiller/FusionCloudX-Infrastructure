---
# ==============================================================================
# Install and Configure Semaphore UI
# ==============================================================================
# Installs Semaphore UI for Ansible automation via web interface
# Connects to PostgreSQL database for storage
# ==============================================================================

- name: Check if Semaphore is already installed
  ansible.builtin.stat:
    path: "{{ semaphore_install_path }}/semaphore"
  register: semaphore_binary_stat

- name: Get latest Semaphore release
  ansible.builtin.uri:
    url: https://api.github.com/repos/semaphoreui/semaphore/releases/latest
    return_content: true
  register: semaphore_latest_release
  when: semaphore_version == "latest"

- name: Set Semaphore version
  ansible.builtin.set_fact:
    semaphore_download_version: "{{ semaphore_latest_release.json.tag_name if semaphore_version == 'latest' else semaphore_version }}"

- name: Display Semaphore version
  ansible.builtin.debug:
    msg: "Installing Semaphore version: {{ semaphore_download_version }}"

- name: Download and install Semaphore
  when: not semaphore_binary_stat.stat.exists
  block:
    - name: Create temporary download directory
      ansible.builtin.tempfile:
        state: directory
        suffix: semaphore
      register: temp_dir

    - name: Download Semaphore binary
      ansible.builtin.get_url:
        url: "https://github.com/semaphoreui/semaphore/releases/download/{{ semaphore_download_version }}/semaphore_{{ semaphore_download_version }}_linux_amd64.tar.gz"
        dest: "{{ temp_dir.path }}/semaphore.tar.gz"
        mode: '0644'

    - name: Extract Semaphore binary
      ansible.builtin.unarchive:
        src: "{{ temp_dir.path }}/semaphore.tar.gz"
        dest: "{{ temp_dir.path }}"
        remote_src: true

    - name: Install Semaphore binary
      ansible.builtin.copy:
        src: "{{ temp_dir.path }}/semaphore"
        dest: "{{ semaphore_install_path }}/semaphore"
        mode: '0755'
        remote_src: true
      become: true

    - name: Clean up temporary files
      ansible.builtin.file:
        path: "{{ temp_dir.path }}"
        state: absent

- name: Create Semaphore configuration directory
  ansible.builtin.file:
    path: "{{ semaphore_config_path }}"
    state: directory
    owner: "{{ ansible_user_name }}"
    group: "{{ ansible_user_name }}"
    mode: '0755'
  become: true

- name: Create Semaphore web root directory
  ansible.builtin.file:
    path: "{{ semaphore_web_root }}"
    state: directory
    owner: "{{ ansible_user_name }}"
    group: "{{ ansible_user_name }}"
    mode: '0755'
  become: true

- name: Create Semaphore configuration file
  ansible.builtin.template:
    src: semaphore_config.json.j2
    dest: "{{ semaphore_config_path }}/config.json"
    owner: "{{ ansible_user_name }}"
    group: "{{ ansible_user_name }}"
    mode: '0600'
  become: true
  notify: Restart Semaphore

- name: Test database connection
  community.postgresql.postgresql_ping:
    db: "{{ semaphore_db_name }}"
    login_host: "{{ semaphore_db_host }}"
    login_user: "{{ semaphore_db_user }}"
    login_password: "{{ semaphore_db_password }}"
  register: db_test
  failed_when: false

- name: Display database connection status
  ansible.builtin.debug:
    msg: "Database connection: {{ 'SUCCESS' if db_test.is_available else 'FAILED' }}"

- name: Create Semaphore systemd service
  ansible.builtin.template:
    src: semaphore.service.j2
    dest: /etc/systemd/system/semaphore.service
    owner: root
    group: root
    mode: '0644'
  become: true
  notify:
    - Reload systemd
    - Restart Semaphore

- name: Enable and start Semaphore service
  ansible.builtin.systemd:
    name: semaphore
    enabled: true
    state: started
    daemon_reload: true
  become: true

- name: Wait for Semaphore to start
  ansible.builtin.wait_for:
    host: "{{ ansible_host }}"
    port: "{{ semaphore_port }}"
    delay: 5
    timeout: 60

- name: Display Semaphore information
  ansible.builtin.debug:
    msg:
      - "=========================================="
      - "Semaphore UI is now running!"
      - "=========================================="
      - "Access URL: http://{{ ansible_host }}:{{ semaphore_port }}"
      - ""
      - "Initial Setup:"
      - "  1. Open the URL in your browser"
      - "  2. Create the first admin user"
      - "  3. Configure the repository:"
      - "      - URL: {{ infra_repo_url }}"
      - "      - Branch: {{ infra_repo_branch }}"
      - "      - Key: Use the deploy key from SSH setup"
      - "  4. Create task templates for playbooks"
      - ""
      - "Repository Path: {{ infra_repo_path }}"
      - "Config Path: {{ semaphore_config_path }}/config.json"
      - "Service: systemctl status semaphore"
      - "=========================================="
