---
# ==============================================================================
# Configure Environment Variables
# ==============================================================================
# Sets up environment variables for Semaphore, Terraform, and 1Password
# ==============================================================================

- name: Create environment file for Semaphore
  ansible.builtin.template:
    src: environment.j2
    dest: /etc/environment.d/semaphore.conf
    owner: root
    group: root
    mode: '0644'
  become: true

- name: Add environment variables to ansible user profile
  ansible.builtin.blockinfile:
    path: "{{ ansible_user_home }}/.bashrc"
    block: |
      # Infrastructure Control Plane Environment Variables
      export OP_SERVICE_ACCOUNT_TOKEN="{{ environment_vars.OP_SERVICE_ACCOUNT_TOKEN }}"
      export PROXMOX_VE_ENDPOINT="{{ environment_vars.PROXMOX_VE_ENDPOINT }}"
      export ANSIBLE_HOST_KEY_CHECKING="{{ environment_vars.ANSIBLE_HOST_KEY_CHECKING }}"

      # SSH Agent
      if [ -f {{ ansible_user_home }}/.ssh/agent.env ]; then
        source {{ ansible_user_home }}/.ssh/agent.env
      fi

      # Terraform aliases
      alias tf='terraform'
      alias tfi='terraform init'
      alias tfp='terraform plan'
      alias tfa='terraform apply'
      alias tfd='terraform destroy'

      # Ansible aliases
      alias ap='ansible-playbook'
      alias av='ansible-vault'

      # Infrastructure repo
      alias infra='cd {{ infra_repo_path }}'
    marker: "# {mark} ANSIBLE MANAGED BLOCK - Semaphore Control Plane"
    create: true
    owner: "{{ ansible_user_name }}"
    group: "{{ ansible_user_name }}"
    mode: '0644'
  become: true

- name: Create systemd environment file
  ansible.builtin.template:
    src: systemd-environment.j2
    dest: /etc/default/semaphore
    owner: root
    group: root
    mode: '0600'
  become: true

- name: Display environment configuration
  ansible.builtin.debug:
    msg:
      - "Environment variables configured for:"
      - "  - 1Password (OP_SERVICE_ACCOUNT_TOKEN)"
      - "  - Proxmox (PROXMOX_VE_ENDPOINT)"
      - "  - Ansible (ANSIBLE_HOST_KEY_CHECKING)"
      - ""
      - "Variables are loaded from:"
      - "  - /etc/environment.d/semaphore.conf"
      - "  - {{ ansible_user_home }}/.bashrc"
      - "  - /etc/default/semaphore (for systemd service)"
