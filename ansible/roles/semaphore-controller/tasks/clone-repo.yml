---
# ==============================================================================
# Clone Infrastructure Repository
# ==============================================================================
# Clones the infrastructure repository to the control plane
# Uses GitHub deploy key for authentication
# ==============================================================================

- name: Check if repository already exists
  ansible.builtin.stat:
    path: "{{ infra_repo_path }}/.git"
  register: repo_exists

- name: Display repository status
  ansible.builtin.debug:
    msg: "Repository already exists at {{ infra_repo_path }}"
  when: repo_exists.stat.exists

- name: Clone infrastructure repository
  when: not repo_exists.stat.exists
  block:
    - name: Ensure parent directory exists
      ansible.builtin.file:
        path: "{{ infra_repo_path | dirname }}"
        state: directory
        owner: "{{ ansible_user_name }}"
        group: "{{ ansible_user_name }}"
        mode: '0755'
      become: true

    - name: Test GitHub SSH connection
      ansible.builtin.command: ssh -T git@github.com
      environment:
        GIT_SSH_COMMAND: "ssh -i {{ ssh_github_deploy_key_path }} -o StrictHostKeyChecking=accept-new"
      register: github_test
      changed_when: false
      failed_when: false
      become: true
      become_user: "{{ ansible_user_name }}"

    - name: Display GitHub connection test result
      ansible.builtin.debug:
        msg: "{{ github_test.stderr }}"

    - name: Clone repository
      ansible.builtin.git:
        repo: "{{ infra_repo_url }}"
        dest: "{{ infra_repo_path }}"
        version: "{{ infra_repo_branch }}"
        key_file: "{{ ssh_github_deploy_key_path }}"
        accept_hostkey: true
      become: true
      become_user: "{{ ansible_user_name }}"
      register: git_clone

    - name: Configure git user for commits
      community.general.git_config:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        scope: local
        repo: "{{ infra_repo_path }}"
      loop:
        - name: user.name
          value: "Semaphore Control Plane"
        - name: user.email
          value: "semaphore@fusioncloudx.home"
      become: true
      become_user: "{{ ansible_user_name }}"

- name: Update repository if it already exists
  when: repo_exists.stat.exists
  block:
    - name: Fetch latest changes
      ansible.builtin.command: git fetch origin
      args:
        chdir: "{{ infra_repo_path }}"
      environment:
        GIT_SSH_COMMAND: "ssh -i {{ ssh_github_deploy_key_path }}"
      become: true
      become_user: "{{ ansible_user_name }}"
      changed_when: false

    - name: Check for local changes
      ansible.builtin.command: git status --porcelain
      args:
        chdir: "{{ infra_repo_path }}"
      register: git_status
      changed_when: false
      become: true
      become_user: "{{ ansible_user_name }}"

    - name: Display warning if local changes exist
      ansible.builtin.debug:
        msg:
          - "WARNING: Local changes detected in repository"
          - "{{ git_status.stdout }}"
          - "Repository will not be updated automatically"
      when: git_status.stdout != ""

    - name: Pull latest changes
      ansible.builtin.command: git pull origin {{ infra_repo_branch }}
      args:
        chdir: "{{ infra_repo_path }}"
      environment:
        GIT_SSH_COMMAND: "ssh -i {{ ssh_github_deploy_key_path }}"
      become: true
      become_user: "{{ ansible_user_name }}"
      when: git_status.stdout == ""
      changed_when: true

- name: Get current commit hash
  ansible.builtin.command: git rev-parse --short HEAD
  args:
    chdir: "{{ infra_repo_path }}"
  register: git_commit
  changed_when: false
  become: true
  become_user: "{{ ansible_user_name }}"

- name: Display repository information
  ansible.builtin.debug:
    msg:
      - "Repository: {{ infra_repo_url }}"
      - "Branch: {{ infra_repo_branch }}"
      - "Commit: {{ git_commit.stdout }}"
      - "Path: {{ infra_repo_path }}"
