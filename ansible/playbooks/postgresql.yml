---
# ==============================================================================
# PostgreSQL Deployment Playbook
# ==============================================================================
# Deploys and configures SINGLE PostgreSQL database server
# This server hosts MULTIPLE databases (semaphore, wazuh, etc.)
# ==============================================================================

- name: Deploy PostgreSQL Database Server
  hosts: postgresql
  become: yes
  gather_facts: yes

  pre_tasks:
    - name: Display target host
      debug:
        msg: "Deploying PostgreSQL to {{ inventory_hostname }} ({{ ansible_host }})"
      tags: ['always']

    - name: Verify 1Password Connect authentication
      debug:
        msg: "Checking 1Password Connect authentication (OP_CONNECT_HOST and OP_CONNECT_TOKEN) or Service Account (OP_SERVICE_ACCOUNT_TOKEN)"
      tags: ['always']

    - name: Check 1Password environment variables
      debug:
        msg: "{{ 'Using 1Password Connect Server' if lookup('env', 'OP_CONNECT_HOST') else ('Using 1Password Service Account' if lookup('env', 'OP_SERVICE_ACCOUNT_TOKEN') else 'WARNING: No 1Password authentication found - set OP_CONNECT_HOST + OP_CONNECT_TOKEN or OP_SERVICE_ACCOUNT_TOKEN') }}"
      tags: ['always']

    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      tags: ['always']

    - name: Set timezone
      timezone:
        name: "{{ timezone | default('America/Chicago') }}"
      tags: ['always']

  roles:
    - role: postgresql
      tags: ['postgresql']

  post_tasks:
    - name: Verify PostgreSQL is running
      systemd:
        name: postgresql
        state: started
      register: postgresql_status
      tags: ['verify']

    - name: Display PostgreSQL version
      command: psql --version
      become: yes
      become_user: postgres
      register: postgresql_version_output
      changed_when: false
      tags: ['verify']

    - name: Show PostgreSQL version
      debug:
        msg: "{{ postgresql_version_output.stdout }}"
      tags: ['verify']

    - name: Test database connectivity
      postgresql_query:
        db: postgres
        login_user: postgres
        query: "SELECT datname FROM pg_database WHERE datistemplate = false;"
      become: yes
      become_user: postgres
      register: databases_list
      tags: ['verify']

    - name: Display deployment summary
      debug:
        msg:
          - "========================================"
          - "PostgreSQL Deployment Complete!"
          - "========================================"
          - "Host: {{ inventory_hostname }}"
          - "IP Address: {{ ansible_host }}"
          - "PostgreSQL Version: {{ postgresql_version_output.stdout }}"
          - "Databases Created: {{ postgresql_databases | map(attribute='name') | list | join(', ') | default('None') }}"
          - "Database Users: {{ postgresql_users | map(attribute='name') | list | join(', ') | default('None') }}"
          - "Active Databases: {{ databases_list.query_result | map(attribute='datname') | list | join(', ') }}"
          - "========================================"
          - "This is a SINGLE instance hosting MULTIPLE databases"
          - "Credentials managed via 1Password"
          - "========================================"
      tags: ['always']
