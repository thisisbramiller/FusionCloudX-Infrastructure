---
# ==============================================================================
# Bootstrap Semaphore Control Plane
# ==============================================================================
# This playbook configures semaphore-ui VM as the Infrastructure Control Plane
#
# USAGE:
#   Run ONCE from your workstation to bootstrap the control plane:
#
#   ansible-playbook -i '<semaphore-ip>,' \
#     -u ansible \
#     playbooks/bootstrap-semaphore.yml \
#     -e "onepassword_service_account_token=<your-token>"
#
# PREREQUISITES:
#   1. semaphore-ui VM is running
#   2. You can SSH to semaphore-ui as 'ansible' user
#   3. PostgreSQL database is running and accessible
#   4. You have a 1Password service account token
#   5. GitHub deploy key is prepared (or will use user key)
#
# AFTER BOOTSTRAP:
#   - Semaphore UI will be accessible at http://<semaphore-ip>:3000
#   - Complete initial setup in Semaphore web interface
#   - Configure repository and task templates
#   - All future automation runs through Semaphore
# ==============================================================================

- name: Bootstrap Semaphore Control Plane
  hosts: all
  become: false
  gather_facts: true

  # ==============================================================================
  # Variables (can be overridden with -e flag)
  # ==============================================================================
  vars:
    # Infrastructure repository
    infra_repo_url: "git@github.com:thisisbramiller/FusionCloudX-Infrastructure.git"
    infra_repo_path: "/opt/infrastructure"
    infra_repo_branch: "main"

    # 1Password configuration
    # Pass this with: -e "onepassword_service_account_token=<your-token>"
    onepassword_service_account_token: ""

    # Proxmox configuration
    proxmox_api_url: "https://192.168.40.206:8006"

    # Environment variables to configure
    environment_vars:
      OP_SERVICE_ACCOUNT_TOKEN: "{{ onepassword_service_account_token }}"
      PROXMOX_VE_ENDPOINT: "{{ proxmox_api_url }}"
      ANSIBLE_HOST_KEY_CHECKING: "False"

    # PostgreSQL database configuration
    semaphore_db_host: "postgresql"
    semaphore_db_port: 5432
    semaphore_db_name: "semaphore"
    semaphore_db_user: "semaphore"
    # In production, retrieve this from 1Password
    # For bootstrap, you may need to pass it as a variable
    semaphore_db_password: "{{ lookup('env', 'SEMAPHORE_DB_PASSWORD') | default('changeme') }}"

    # Managed hosts (add your other VMs here)
    managed_hosts:
      - hostname: "teleport"
        ansible_host: "{{ hostvars['teleport']['ansible_host'] | default('') }}"
      - hostname: "wazuh"
        ansible_host: "{{ hostvars['wazuh']['ansible_host'] | default('') }}"
      - hostname: "immich"
        ansible_host: "{{ hostvars['immich']['ansible_host'] | default('') }}"
      - hostname: "postgresql"
        ansible_host: "{{ hostvars['postgresql']['ansible_host'] | default('') }}"

  # ==============================================================================
  # Pre-flight checks
  # ==============================================================================
  pre_tasks:
    - name: Display bootstrap information
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "SEMAPHORE CONTROL PLANE BOOTSTRAP"
          - "=========================================="
          - "Target Host: {{ inventory_hostname }}"
          - "Repository: {{ infra_repo_url }}"
          - "Branch: {{ infra_repo_branch }}"
          - "Installation Path: {{ infra_repo_path }}"
          - ""
          - "This will install and configure:"
          - "  • Terraform"
          - "  • 1Password CLI"
          - "  • Ansible collections"
          - "  • Semaphore UI"
          - "  • SSH keys for infrastructure access"
          - "  • Infrastructure repository clone"
          - "=========================================="

    - name: Verify 1Password token is provided
      ansible.builtin.assert:
        that:
          - onepassword_service_account_token != ""
          - onepassword_service_account_token | length > 10
        fail_msg: "1Password service account token is required! Pass with -e 'onepassword_service_account_token=<token>'"
        success_msg: "1Password token provided"

    - name: Verify database password is set
      ansible.builtin.assert:
        that:
          - semaphore_db_password != "changeme"
        fail_msg: "Database password must be set! Set SEMAPHORE_DB_PASSWORD environment variable or pass with -e"
        success_msg: "Database password configured"
      when: false  # Skip for now, can configure manually in Semaphore

    - name: Test database connectivity
      ansible.builtin.wait_for:
        host: "{{ semaphore_db_host }}"
        port: "{{ semaphore_db_port }}"
        timeout: 10
      register: db_connectivity
      failed_when: false

    - name: Display database connectivity status
      ansible.builtin.debug:
        msg: "Database connectivity: {{ 'SUCCESS' if db_connectivity.failed == false else 'FAILED - Continue anyway' }}"

  # ==============================================================================
  # Apply semaphore-controller role
  # ==============================================================================
  roles:
    - role: semaphore-controller
      tags:
        - semaphore
        - controller

  # ==============================================================================
  # Post-bootstrap tasks
  # ==============================================================================
  post_tasks:
    - name: Display next steps
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "BOOTSTRAP COMPLETE!"
          - "=========================================="
          - ""
          - "Semaphore UI: http://{{ ansible_host }}:3000"
          - ""
          - "NEXT STEPS:"
          - ""
          - "1. CONFIGURE GITHUB DEPLOY KEY:"
          - "   • Copy the public key displayed during SSH setup"
          - "   • Add to GitHub: Settings → Deploy keys"
          - "   • Allow write access if you want to push from Semaphore"
          - ""
          - "2. CONFIGURE PROXMOX SSH ACCESS:"
          - "   • Copy the Proxmox public key displayed during setup"
          - "   • Add to Proxmox 'terraform' user authorized_keys"
          - "   • Test: ssh -i ~/.ssh/proxmox_terraform_key terraform@192.168.40.206"
          - ""
          - "3. INITIAL SEMAPHORE SETUP:"
          - "   • Open http://{{ ansible_host }}:3000 in browser"
          - "   • Create first admin user"
          - "   • Configure project settings"
          - ""
          - "4. ADD REPOSITORY TO SEMAPHORE:"
          - "   • Click 'New Repository'"
          - "   • Git URL: {{ infra_repo_url }}"
          - "   • Branch: {{ infra_repo_branch }}"
          - "   • SSH Key: Select the deploy key"
          - ""
          - "5. CREATE TASK TEMPLATES:"
          - "   • Example: 'Deploy Infrastructure' → terraform apply"
          - "   • Example: 'Configure Hosts' → ansible-playbook site.yml"
          - "   • Example: 'Update Inventory' → update-inventory.sh"
          - ""
          - "6. TEST YOUR SETUP:"
          - "   • Run a simple playbook from Semaphore"
          - "   • Verify logs and output"
          - "   • Check infrastructure state"
          - ""
          - "=========================================="
          - "You can now manage all infrastructure"
          - "through the Semaphore UI!"
          - "=========================================="

    - name: Save bootstrap summary to file
      ansible.builtin.copy:
        content: |
          # Semaphore Control Plane Bootstrap Summary

          Completed: {{ ansible_date_time.iso8601 }}
          Host: {{ inventory_hostname }}

          ## Installed Components:
          - Terraform: {{ terraform_verify.stdout_lines[0] }}
          - 1Password CLI: v{{ op_verify_final.stdout }}
          - Semaphore UI: {{ semaphore_verify.stdout }}
          - Repository: {{ infra_repo_path }}

          ## Access:
          - Semaphore UI: http://{{ ansible_host }}:3000

          ## SSH Keys Generated:
          - Management: {{ ssh_management_key_path }}
          - GitHub: {{ ssh_github_deploy_key_path }}
          - Proxmox: {{ ssh_proxmox_key_path }}

          ## Next Steps:
          1. Configure GitHub deploy key
          2. Configure Proxmox SSH access
          3. Complete Semaphore initial setup
          4. Add repository to Semaphore
          5. Create task templates
          6. Test automation
        dest: "{{ ansible_user_home }}/bootstrap-summary.txt"
        owner: "{{ ansible_user_name }}"
        group: "{{ ansible_user_name }}"
        mode: '0644'
      become: true
